数据库**分库分表**是应对**数据量过大、并发过高、单库性能瓶颈**的核心手段。下面我从**什么时候用、怎么分、常见方案、设计要点、典型架构**几个维度系统讲清楚，偏工程实战 👇

---

## 一、什么时候需要分库分表？

一般出现以下情况之一就要考虑：

1. **单表数据量过大**

   * MySQL/InnoDB：

     * > **500万行**：查询明显变慢
     * > **2000万行**：必须分表
2. **并发写入高**

   * 单库 QPS > 2k~5k
3. **索引过多 / 锁冲突严重**
4. **磁盘 / CPU / IO 达到瓶颈**
5. **业务天然可切分**

   * 用户、订单、日志等

---

## 二、分库 vs 分表

| 类型      | 解决问题       | 说明         |
| ------- | ---------- | ---------- |
| 分表      | 单表数据量      | 表拆成多张      |
| 分库      | 并发 & IO    | 数据分散到多个数据库 |
| 分库 + 分表 | 高并发 + 海量数据 | 终极形态       |

---

## 三、分表方案（重点）

### 1️⃣ 水平分表（最常用）

**按某个字段取模 / 范围**

#### 示例：按 user_id 分表

```text
user_0
user_1
...
user_15
```

```sql
user_id % 16 = table_index
```

**优点**

* 规则简单
* 扩展性强

**缺点**

* 跨表查询复杂
* 扩容困难（表数固定）

---

### 2️⃣ 范围分表

```text
order_202401
order_202402
```

**适合**

* 时间序列数据（订单、日志）

**优点**

* 历史数据易归档
* 查询命中率高

**缺点**

* 热点月份压力大

---

### 3️⃣ 垂直分表（字段拆分）

```text
user_base (id, name, phone)
user_ext  (id, avatar, bio)
```

**适合**

* 大字段（TEXT/BLOB）
* 冷热字段明显

---

## 四、分库方案

### 1️⃣ 按业务拆库（垂直拆库）

```text
user_db
order_db
payment_db
```

✔ 微服务架构首选
✔ 降低耦合

---

### 2️⃣ 按数据拆库（水平拆库）

```text
user_db_0 -> user_0 ~ user_7
user_db_1 -> user_8 ~ user_15
```

```text
db_index = user_id % 2
table_index = user_id % 16
```

---

## 五、常见组合方案（实战）

### ⭐ 方案一：用户系统

```text
user_db_{0..3}
  └── user_{0..15}
```

```text
db = user_id % 4
table = user_id % 16
```

---

### ⭐ 方案二：订单系统

```text
order_db_{0..7}
  └── order_{202401..202412}
```

* 按 **用户ID分库**
* 按 **时间分表**

---

## 六、分片键（Sharding Key）选择

**好分片键 = 访问频率最高字段**

✔ user_id
✔ order_id（雪花ID）
❌ 性别、状态、类型（低区分度）

**原则**

1. 查询必须带分片键
2. 尽量避免跨库查询
3. 写入均匀

---

## 七、ID 生成方案（非常关键）

### 推荐方案

* **雪花算法（Snowflake）**
* **Leaf（美团）**
* **Redis INCR + 号段**

❌ 不推荐自增 ID（跨库冲突）

---

## 八、跨库问题如何解决？

### 1️⃣ 跨库 JOIN

❌ 禁止
✔ 应用层 JOIN / 冗余字段

---

### 2️⃣ 跨库事务

* **最终一致性**

  * 消息队列（MQ）
  * TCC / Saga

---

### 3️⃣ 聚合查询

* 多库并行查询
* 应用层聚合

---

## 九、中间件方案（成熟方案）

### 1️⃣ ShardingSphere（推荐）

* Apache 官方
* 支持分库分表 + 读写分离
* SQL 透明

### 2️⃣ MyCat

* 老牌，配置复杂

### 3️⃣ 应用层路由（自研）

* 性能最好
* 灵活
* 开发成本高

---

## 十、典型架构图（文字版）

```text
Client
  ↓
Gateway
  ↓
Service
  ↓
Sharding Router
  ↓
DB_0 (table_0 ~ table_7)
DB_1 (table_8 ~ table_15)
```

---

## 十一、常见坑 ⚠️

❌ 事后分库（数据迁移地狱）
❌ 分片键选错
❌ 跨库分页
❌ 全局唯一索引
❌ 表数量过多（>1024）

---

## 十二、落地建议（经验）

1. **优先分表，再分库**
2. **分片数提前规划好（2 的幂）**
3. **所有查询强制带分片键**
4. **冷热数据分离**
5. **提前设计扩容方案**

---

如果你愿意，我可以直接帮你：

* ✅ 设计 **你当前业务的分库分表方案**
* ✅ 给出 **ShardingSphere 配置示例**
* ✅ 模拟 **从单库迁移到分库分表的步骤**

你可以告诉我：
👉 **业务类型（用户/订单/日志）**
👉 **当前数据量 & QPS**
👉 **MySQL / PostgreSQL / 其他**
