**容灾与高可用保障（DR & HA）**是保障系统**连续可用、数据安全、快速恢复**的核心能力，常见于互联网平台、金融系统、云原生架构等场景。下面从**目标、架构层次、关键技术、常见方案、指标与实践**系统说明。

---

## 一、核心目标

| 目标      | 说明                                  |
| ------- | ----------------------------------- |
| 高可用（HA） | 单点故障不影响服务（99.9% / 99.99% / 99.999%） |
| 容灾（DR）  | 机房级 / 城市级 / 区域级灾难下快速恢复              |
| 数据安全    | 防止数据丢失、数据不一致                        |
| 快速恢复    | 控制 **RTO / RPO**                    |

### 关键指标

* **RTO（Recovery Time Objective）**：可接受的最长恢复时间
* **RPO（Recovery Point Objective）**：可接受的数据丢失时间窗口

---

## 二、高可用 vs 容灾

| 维度   | 高可用（HA）      | 容灾（DR）       |
| ---- | ------------ | ------------ |
| 故障级别 | 进程 / 主机 / 服务 | 机房 / 城市 / 区域 |
| 技术重点 | 冗余、自动切换      | 备份、异地多活      |
| 切换方式 | 秒级自动         | 分钟～小时        |
| 代表技术 | LB、主从、集群     | 同城双活、异地灾备    |

👉 **关系**：

> HA 解决“常见故障”，DR 解决“极端灾难”

---

## 三、分层容灾与高可用设计

### 1️⃣ 接入层（流量入口）

**目标：入口无单点**

* DNS 多记录（权重 / 健康检查）
* 全局流量调度（GSLB）
* 多地域 CDN
* 四/七层负载均衡（Nginx / LVS / SLB）

```text
User
 ↓
DNS / GSLB
 ↓
LB（多实例）
 ↓
服务集群
```

---

### 2️⃣ 应用层（服务高可用）

**核心策略**

* 无状态服务（State 外置）
* 服务多实例
* 健康检查 + 自动摘除
* 自动扩缩容（HPA）

**技术手段**

* Kubernetes Deployment / ReplicaSet
* Spring Cloud / Dubbo + 注册中心
* 熔断（Circuit Breaker）
* 限流 / 降级

---

### 3️⃣ 数据层（最关键）

#### 数据库高可用

| 方案           | 特点      |
| ------------ | ------- |
| 主从复制         | 简单、读写分离 |
| 主主复制         | 冲突处理复杂  |
| MGR / Galera | 强一致     |
| 云数据库         | 自动 HA   |

#### 数据库容灾

* 同城双机房（同步复制）
* 异地灾备（异步复制）
* 定期全量 + 增量备份

**典型模式**

```text
主库（A） ──同步── 备库（B）
   │
   └──异步── 异地灾备（C）
```

---

### 4️⃣ 缓存与中间件

#### Redis

* 主从 + Sentinel
* Redis Cluster
* 多活（业务容忍不一致）

#### MQ

* 多 Broker 副本
* 消息持久化
* 消费幂等

---

## 四、常见容灾架构模式

### ① 单机房高可用（入门）

* 同机房多实例
* 主从数据库
* **RTO：分钟级**

---

### ② 同城双活（主流）

* 两个机房同时对外提供服务
* 数据强一致或最终一致
* 流量按比例分配

**优点**：切换快
**难点**：数据一致性、事务

---

### ③ 异地多活（高阶）

* 跨城市 / 跨地域
* 业务分片（按用户、区域）
* 多活写入（复杂）

**适合**：金融、核心交易系统

---

### ④ 冷备 / 热备 / 温备

| 类型 | 成本 | 恢复速度 |
| -- | -- | ---- |
| 冷备 | 低  | 慢    |
| 温备 | 中  | 中    |
| 热备 | 高  | 快    |

---

## 五、自动化与治理能力

### 自动切换

* 心跳检测
* 主从自动切换
* DNS / LB 自动变更

### 监控与告警

* SLA / SLO
* 业务指标 > 系统指标
* 多渠道告警

### 演练机制

* 容灾演练（GameDay）
* 定期故障注入（Chaos Engineering）

---

## 六、典型企业实践参考

| 场景   | 建议方案            |
| ---- | --------------- |
| 中小系统 | 单活 + 异地备份       |
| 核心业务 | 同城双活            |
| 金融级  | 异地多活 + 强一致      |
| 云原生  | 多 AZ + 多 Region |

---

## 七、设计原则总结

✅ 消除单点
✅ 先 HA，后 DR
✅ 自动化优先，人工兜底
✅ 数据层优先保障
✅ 架构简单优于“炫技”

---

如果你愿意，我可以进一步帮你：

* 设计 **具体系统的容灾方案**（如：电商 / 金融 / SaaS）
* 给出 **架构图（文字版 or 图示）**
* 对比 **同城双活 vs 异地多活**
* 给出 **RTO / RPO 评估模板**

你更关注哪一层或哪种场景？
